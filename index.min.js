function updateMenu(){var e=document.getElementById("undo");currentGameIndex>0?e.classList.remove("inactive"):e.classList.add("inactive");var r=document.getElementById("redo");currentGameIndex==currentGameHistory.length-1?r.classList.add("inactive"):r.classList.remove("inactive")}function getServingSide(e,r){return e.A.s==e.B.s&&0==e.A.s?e.A.w<e.B.w?"a":"b":r.A.d>0?"a":"b"}function updateField(e,r){var t=getServingSide(e,r),n=null;n=e.A.s==e.B.s&&0==e.A.s?"r":"a"==t?e.A.s%2==0?"r":"l":e.B.s%2==0?"r":"l";var c="player "+t+" "+n;if(prevField=currentField,prevField)for(var a=0;a<prevField.length;a++)prevField[a].classList.remove("active");currentField=document.getElementsByClassName(c);for(a=0;a<currentField.length;a++)currentField[a].classList.add("active");updateMenu()}function updatePlayer(e){for(var r=document.getElementsByClassName("player a l"),t=0;t<r.length;t++)r[t].innerText=e.A.p[0];var n=document.getElementsByClassName("player a r");for(t=0;t<n.length;t++)n[t].innerText=e.A.p[1];var c=document.getElementsByClassName("player b l");for(t=0;t<c.length;t++)c[t].innerText=e.B.p[0];var a=document.getElementsByClassName("player b r");for(t=0;t<a.length;t++)a[t].innerText=e.B.p[1]}function updateScore(e){for(var r=document.getElementsByClassName("score a"),t=0;t<r.length;t++)r[t].innerText=String(e.A.s).padStart(2,"0");var n=document.getElementsByClassName("score b");for(t=0;t<n.length;t++)n[t].innerText=String(e.B.s).padStart(2,"0");var c=document.getElementsByClassName("win a");for(t=0;t<c.length;t++)c[t].innerText=String(e.A.w).padStart(2,"0");var a=document.getElementsByClassName("win b");for(t=0;t<a.length;t++)a[t].innerText=String(e.B.w).padStart(2,"0")}function resetGame(){currentScores.A.s=0,currentScores.B.s=0,currentGameIndex=0,currentGameHistory=structuredClone(initGameHistory),currentMaxScore=defaultMaxScore}function shiftGame(e){var r=null;if(e<0){if(0==currentGameIndex)return;r=currentGameHistory[currentGameIndex],currentScores.A.s-=r.A.d,currentScores.B.s-=r.B.d,currentGameIndex--,r=currentGameHistory[currentGameIndex]}else{if(currentGameIndex==currentGameHistory.length-1)return;currentGameIndex++,r=currentGameHistory[currentGameIndex],currentScores.A.s+=r.A.d,currentScores.B.s+=r.B.d}updateScore(currentScores),updateField(currentScores,r),updatePlayer(r)}function checkScore(e,r){if(e.A.s==currentMaxScore||e.B.s==currentMaxScore){var t=document.getElementById("whistle-blow");t&&"up"==currentVolume&&t.play(),resetGame(),updateScore(e),updateField(e,r),updatePlayer(currentGameHistory[currentGameIndex])}else e.A.s==e.B.s&&e.A.s>=20&&(currentMaxScore=e.A.s+2),updateField(e,r),updatePlayer(r);localStorage.setItem("scores",JSON.stringify(e))}function getScoreInfo(){var e=localStorage.getItem("scores");currentScores=e?JSON.parse(e):structuredClone(initScores);var r=localStorage.getItem("volume");r&&(currentVolume=r,document.getElementById("volume").innerText="volume_"+currentVolume);var t=localStorage.getItem("field-3d");t&&(currentField3D="true"==t);var n=localStorage.getItem("history");if(n){currentGameHistory=JSON.parse(n),currentGameIndex=currentGameHistory.length-1;var c=currentGameHistory[currentGameIndex];updateField(currentScores,c)}else currentGameHistory=structuredClone(initGameHistory);updateScore(currentScores),checkScore(currentScores,currentGameHistory[currentGameIndex])}function pushGameHistory(e){currentGameHistory.push(structuredClone(e)),localStorage.setItem("history",JSON.stringify(currentGameHistory)),currentGameIndex++}function increaseScore(e){if(99!=currentScores.A.s&&99!=currentScores.B.s&&99!=currentScores.A.w&&99!=currentScores.B.w){currentGameIndex!=currentGameHistory.length-1&&(currentGameHistory=currentGameHistory.slice(0,currentGameIndex+1));var r=structuredClone(currentGameHistory[currentGameIndex]),t=getServingSide(currentScores,r);"object"==typeof e&&e.classList.contains("a")||"a"==e?("a"==t&&r.A.p.reverse(),currentScores.A.s+=1,currentScores.A.s==currentMaxScore&&(currentScores.A.w+=1),r.A.d=1,r.B.d=0):("object"==typeof e&&e.classList.contains("b")||"b"==e)&&("b"==t&&r.B.p.reverse(),currentScores.B.s+=1,currentScores.B.s==currentMaxScore&&(currentScores.B.w+=1),r.A.d=0,r.B.d=1),pushGameHistory(r),updateScore(currentScores),checkScore(currentScores,r)}}function resetAllGames(){currentScores=structuredClone(initScores),resetGame(),updateScore(currentScores),checkScore(currentScores,currentGameHistory[currentGameIndex]),localStorage.removeItem("history")}function toggleVolume(e){null==e&&(e=document.getElementById("volume")),currentVolume="up"==currentVolume?"off":"up",e.innerText="volume_"+currentVolume,localStorage.setItem("volume",currentVolume)}function waitForResetAllGames(){null==resetTimeoutHandle&&(resetTimeoutHandle=setTimeout(resetAllGames,3e3))}function cancelResetAllGames(){resetTimeoutHandle&&(clearTimeout(resetTimeoutHandle),resetTimeoutHandle=null)}var noSleep=new NoSleep(!0);const defaultMaxScore=21,initGameHistory=[{A:{d:0,p:[2,1]},B:{d:0,p:[2,1]}}],initScores={A:{s:0,w:0},B:{s:0,w:0}};var currentScores=null,currentMaxScore=defaultMaxScore,prevField=null,currentField=null,currentGameIndex=0,currentGameHistory=null,resetTimeoutHandle=null,currentVolume="off",currentField3D=!1;document.addEventListener("readystatechange",()=>{"complete"==document.readyState&&document.addEventListener("click",function e(){document.removeEventListener("click",e,!1),noSleep.enable()},!1)}),document.addEventListener("DOMContentLoaded",()=>{var e=-1==window.location.search.indexOf("nocache=1")&&"serviceWorker"in navigator;e&&(navigator.serviceWorker.addEventListener("message",e=>{"installed"==e.data&&window.location.reload()}),navigator.serviceWorker.register("/scoreboard-web/sw.min.js")),getScoreInfo(),document.addEventListener("keydown",e=>{switch(e.key){case",":shiftGame(-1);break;case".":shiftGame(1);break;case"Delete":waitForResetAllGames();break;case"V":case"v":toggleVolume();break;case"B":case"b":increaseScore("a");break;case"R":case"r":increaseScore("b")}}),document.addEventListener("keyup",e=>{"Delete"==e.key&&cancelResetAllGames()});for(var r=document.getElementsByClassName("score"),t=0;t<r.length;t++)r[t].addEventListener("click",e=>{increaseScore(e.target)});var n=document.getElementsByClassName("field-panel");for(t=0;t<n.length;t++)currentField3D&&n[t].classList.toggle("transform"),n[t].addEventListener("click",e=>{e.target.classList.toggle("transform"),localStorage.setItem("field-3d",e.target.classList.contains("transform"))});var c=document.getElementById("reset"),a="mousedown",s="mouseup";"ontouchstart"in window&&(a="touchstart",s="touchend"),c.addEventListener(a,waitForResetAllGames),c.addEventListener(s,cancelResetAllGames);var o=document.getElementById("reload");o.addEventListener("click",r=>{e&&navigator.serviceWorker.controller.postMessage("delete-cache")});var u=document.getElementById("undo");u.addEventListener("click",e=>{shiftGame(-1)});var l=document.getElementById("redo");l.addEventListener("click",e=>{shiftGame(1)});var i=document.getElementById("volume");i.addEventListener("click",e=>{toggleVolume(e.target)})});